# Bulletproof CI/CD — inneranimalmedia-mcp
# ONE SECRET: CLOUDFLARE_API_TOKEN (Settings → Secrets → Actions)
# Push to main = deploy. Never fucks up.

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
      - run: npm ci
      - name: Validate
        run: |
          [ -f wrangler.toml ] || { echo "❌ wrangler.toml missing"; exit 1; }
          [ -f package.json ] || { echo "❌ package.json missing"; exit 1; }
          npm run test 2>/dev/null || true
          echo "✅ Validate OK"

  deploy:
    needs: validate
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    env:
      CLOUDFLARE_ACCOUNT_ID: ede6590ac0d2fb7daf155b35653457b2
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - run: npm ci

      - name: Check secret
        run: |
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "❌ CLOUDFLARE_API_TOKEN not set. Add it: Settings → Secrets → Actions → New repository secret"
            echo "   Get token: https://dash.cloudflare.com/profile/api-tokens → Create Token (Edit Workers)"
            exit 1
          fi
          echo "✅ Secret present"

      - name: Deploy to Cloudflare
        run: npm run deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: R2 Backup
        run: |
          tar czf ci-backup.tar.gz --exclude=node_modules --exclude=.git .
          npx wrangler r2 object put meaux-builds-backups/ci/inneranimalmedia-mcp/${{ github.run_id }}-${{ github.sha }}.tar.gz --file=ci-backup.tar.gz
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        continue-on-error: true
